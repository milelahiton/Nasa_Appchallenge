<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clean Breath - Monitor de Calidad del Aire (ICA)</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
          
    <!-- Configuración para usar la fuente Inter y colores personalizados -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #e0f7fa 0%, #e8eaf6 100%);
        }
        .particle-icon {
            fill: currentColor;
            width: 16px;
            height: 16px;
        }
        .icon-btn {
            height: 40px;
            width: 40px;
        }
        .recommendation-icon {
            height: 24px;
            width: 24px;
        }
        /* Estilo para los interruptores del perfil de salud */
        .toggle-switch:checked {
            @apply bg-indigo-600;
        }
        .toggle-switch:checked + .slider {
            transform: translateX(20px);
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- PANTALLA DE INICIO (SPLASH SCREEN) -->
    <div id="splash-screen" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-indigo-600 transition-opacity duration-700 cursor-pointer">
        <div class="animate-pulse">
            <!-- Ícono de Respiración -->
            <svg xmlns="http://www.w3.org/2000/svg" class="h-20 w-20 text-white mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 18H7v-1a6 6 0 016-6v12z" />
            </svg>
        </div>
        <h2 class="text-4xl font-extrabold text-white tracking-wider">Clean Breath</h2>
        <p class="text-base text-indigo-200 mt-2">Monitoreo de Calidad del Aire para Viajes</p>
        
        <p class="text-sm font-semibold text-indigo-200 mt-8 opacity-90 animate-bounce">
            Toca para continuar
        </p>
    </div>
    <!-- FIN PANTALLA DE INICIO -->

    <!-- Contenedor Principal de la Aplicación -->
    <div id="main-app-container" class="w-full max-w-lg bg-white shadow-2xl rounded-3xl p-6 md:p-10 border border-gray-100/50 hidden">

        <!-- MENÚ DE SELECCIÓN DE UBICACIÓN (Paso 1) -->
        <div id="location-prompt-menu" class="text-center p-8 transition-opacity duration-300 hidden">
            <h2 class="text-2xl font-extrabold text-gray-800 mb-2">Paso 1: &iquest;D&oacute;nde quieres ir?</h2>
            <p class="text-gray-500 mb-8">Selecciona tu destino de viaje o ubicaci&oacute;n actual.</p>
            
            <div class="space-y-4">
                <button id="location-current-btn" 
                        class="w-full flex items-center justify-start p-4 bg-indigo-50 border-2 border-indigo-200 text-indigo-700 rounded-xl font-bold text-lg hover:bg-indigo-100 transition duration-150 shadow-md active:scale-[0.99]">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon-btn mr-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                        <circle cx="12" cy="10" r="3"></circle>
                    </svg>
                    Mi Ubicaci&oacute;n Actual
                </button>
                
                <button id="location-manual-btn" 
                        class="w-full flex items-center justify-start p-4 bg-gray-50 border-2 border-gray-200 text-gray-700 rounded-xl font-bold text-lg hover:bg-gray-100 transition duration-150 shadow-md active:scale-[0.99]">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon-btn mr-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                    Buscar un Destino de Viaje
                </button>
            </div>
            
            <p id="location-error-status" class="text-sm text-red-600 font-semibold mt-4 hidden p-3 bg-red-100 border border-red-300 rounded-lg"></p>
        </div>
        <!-- FIN MENÚ DE SELECCIÓN DE UBICACIÓN -->

        <!-- MENÚ DE PERFIL DE SALUD (Paso 2 - NUEVO) -->
        <div id="health-profile-menu" class="text-center p-8 transition-opacity duration-300 hidden">
            <h2 class="text-2xl font-extrabold text-gray-800 mb-2">Paso 2: Perfil de Salud</h2>
            <p class="text-gray-500 mb-6">Selecciona si t&uacute; o tus compa&ntilde;eros de viaje tienen alguna condici&oacute;n sensible.</p>
            
            <div class="space-y-4 text-left">
                <!-- Toggle para Asma o EPOC -->
                <div class="flex items-center justify-between p-4 bg-white border border-indigo-200 rounded-xl shadow-sm">
                    <label for="profile-asthma" class="text-gray-700 font-medium">Asma o Problemas Respiratorios Cr&oacute;nicos (EPOC)</label>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="profile-asthma" class="sr-only peer toggle-switch">
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all slider"></div>
                    </label>
                </div>
                
                <!-- Toggle para Alergias Severas -->
                <div class="flex items-center justify-between p-4 bg-white border border-indigo-200 rounded-xl shadow-sm">
                    <label for="profile-allergies" class="text-gray-700 font-medium">Alergias Ambientales Severas</label>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="profile-allergies" class="sr-only peer toggle-switch">
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all slider"></div>
                    </label>
                </div>
                
                <!-- Toggle para Problemas Cardíacos -->
                <div class="flex items-center justify-between p-4 bg-white border border-indigo-200 rounded-xl shadow-sm">
                    <label for="profile-cardiac" class="text-gray-700 font-medium">Problemas Card&iacute;acos o Presi&oacute;n Alta</label>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="profile-cardiac" class="sr-only peer toggle-switch">
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all slider"></div>
                    </label>
                </div>
                
                <!-- Toggle para Menores o Adultos Mayores -->
                <div class="flex items-center justify-between p-4 bg-white border border-indigo-200 rounded-xl shadow-sm">
                    <label for="profile-age" class="text-gray-700 font-medium">Ni&ntilde;os peque&ntilde;os o Adultos Mayores (65+)</label>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="profile-age" class="sr-only peer toggle-switch">
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all slider"></div>
                    </label>
                </div>
            </div>

            <button id="confirm-profile-btn" 
                    class="w-full mt-8 p-4 bg-indigo-600 text-white rounded-xl font-bold text-lg hover:bg-indigo-700 transition duration-150 shadow-lg active:scale-[0.99]">
                Ver Calidad del Aire y Recomendaciones
            </button>
            
            <!-- Botón para volver atrás (por si se equivocó de ubicación) -->
            <button id="back-to-location-btn" 
                    class="w-full mt-3 p-2 text-sm text-gray-500 hover:text-indigo-600 transition duration-150">
                &larr; Cambiar Ubicaci&oacute;n
            </button>
        </div>
        <!-- FIN MENÚ DE PERFIL DE SALUD -->

        <!-- Contenido Principal (Paso 3) -->
        <div id="main-content-area" class="relative hidden">
            
            <!-- Botón para volver al menú de selección -->
            <button id="back-to-menu-btn" 
                    class="absolute top-[-10px] left-[-10px] p-2 bg-gray-100 rounded-full text-gray-600 hover:bg-gray-200 transition duration-150 shadow-md">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
            </button>
            
            <!-- Título -->
            <div class="text-center mb-8 pt-4">
                <h1 class="text-3xl font-extrabold text-gray-800">
                    <span class="text-indigo-600">Clean Breath</span>
                </h1>
                <p class="text-base text-gray-500 font-medium mt-1 italic">
                    Monitoreando tu viaje
                </p>
            </div>

            <!-- Formulario de Búsqueda de Ciudad (Oculto, solo para mostrar la ciudad actual) -->
            <div class="mb-8">
                <div class="flex space-x-2">
                    <input type="text" id="city-input" placeholder="Buscar ciudad, ej: 'Madrid, ES' o 'San Luis, AR'"
                           class="flex-grow p-3 border border-gray-300 rounded-xl focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition duration-150 shadow-sm"
                           value="Bogot&aacute;, CO" disabled>
                    <button id="search-button-dummy" 
                            class="p-3 bg-gray-300 text-gray-600 rounded-xl font-semibold shadow-md active:scale-[0.98]" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </button>
                </div>
                <p id="location-name" class="text-sm text-gray-600 mt-2 text-center font-medium"></p>
            </div>

            <!-- Mensaje de Carga (Loading State) -->
            <div id="loading-message" class="text-center p-12 transition-opacity duration-300 hidden">
                <svg class="animate-spin h-10 w-10 text-indigo-500 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="text-xl font-semibold text-indigo-600">Cargando datos del ICA...</p>
                <p class="text-sm text-gray-500 mt-1">Calculando recomendaciones personales...</p>
            </div>

            <!-- Mensaje de Error (Error State) -->
            <div id="error-message" class="hidden text-center p-10 bg-red-50 border-2 border-red-400 rounded-xl transition-opacity duration-300 shadow-lg">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-red-600 mx-auto mb-4" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                </svg>
                <p class="text-2xl font-bold text-red-800">¡Algo sali&oacute; mal!</p>
                <p class="text-base text-red-600 mt-2">
                    No pudimos obtener la calidad del aire. Por favor, verifica tu clave API o la conexi&oacute;n.
                </p>
                <code id="error-detail" class="text-xs text-red-500 block mt-2 p-2 bg-red-100 rounded"></code>
            </div>

            <!-- Sección de Datos del ICA (Success State) -->
            <div id="airQualityData" class="hidden transition-opacity duration-300">
                
                <!-- Tarjeta ICA Principal (Gradientes dinámicos y Hover Effect) -->
                <div id="ica-card" class="rounded-2xl p-8 text-white text-center shadow-2xl bg-gradient-to-br transform transition duration-500 hover:scale-[1.05] cursor-pointer">
                    <p class="text-lg font-light opacity-90">&Iacute;ndice de Calidad del Aire (ICA)</p>
                    <p id="ica-value" class="text-8xl font-extrabold mt-1 mb-2"></p>
                    <p id="ica-level" class="text-3xl font-bold uppercase tracking-widest"></p>
                    <p id="ica-description" class="text-sm font-light mt-3 italic opacity-90"></p>
                </div>

                <!-- SECCIÓN: RECOMENDACIONES PERSONALIZADAS -->
                <div class="mt-8">
                    <h2 class="text-xl font-bold text-gray-800 border-b-2 border-indigo-100 pb-3 mb-4">Recomendaciones **PERSONALIZADAS**</h2>
                    <div id="health-recommendations" class="space-y-3">
                        <!-- Las recomendaciones se inyectarán aquí -->
                    </div>
                </div>

                <!-- Detalle de Contaminantes -->
                <div class="mt-8 space-y-4">
                    <h2 class="text-xl font-bold text-gray-800 border-b-2 border-indigo-100 pb-3">Detalle de Contaminantes</h2>
                    <div id="contaminant-list" class="space-y-3">
                        <!-- Los contaminantes se inyectarán aquí -->
                    </div>
                </div>
            </div>

            <!-- Información de Ubicación Fija y Créditos -->
            <div class="mt-10 pt-5 border-t border-gray-100 text-sm text-gray-500 text-center">
                <p id="coords-display" class="mt-1">Coordenadas: Latitud N/A, Longitud N/A</p>
                <p class="mt-1 font-semibold text-gray-600">
                    Datos potenciados por TEMPO.
		La misión TEMPO es una colaboración entre el Observatorio Astrofísico Smithsoniano y la NASA; cuenta con el apoyo de la Dirección de Misiones Científicas de la NASA.
                </p>
            </div>
            
        </div>
        <!-- FIN Contenido Principal -->

    </div>

    <script>
        // CONFIGURACIÓN CLAVE
        const API_KEY = "bf0d6a13c68197b1c3b2e04206adb56f";
        const GEO_API_URL = "https://api.openweathermap.org/geo/1.0/direct";
        const REVERSE_GEO_API_URL = "https://api.openweathermap.org/geo/1.0/reverse";
        const AIR_POLLUTION_API_URL = "https://api.openweathermap.org/data/2.5/air_pollution";
        
        // Estado Global
        let currentCity = "Bogot&aacute;, CO"; 
        let currentLat = 4.60;
        let currentLon = -74.08;
        let userProfile = {
            asthma: false,
            allergies: false,
            cardiac: false,
            ageSensitive: false,
        };
        
        // Referencias a elementos del DOM
        const mainAppContainer = document.getElementById('main-app-container');
        const splashScreen = document.getElementById('splash-screen'); 
        
        const locationPromptMenu = document.getElementById('location-prompt-menu');
        const locationCurrentBtn = document.getElementById('location-current-btn');
        const locationManualBtn = document.getElementById('location-manual-btn');
        const locationErrorStatus = document.getElementById('location-error-status');
        
        const healthProfileMenu = document.getElementById('health-profile-menu');
        const confirmProfileBtn = document.getElementById('confirm-profile-btn');
        const backToLocationBtn = document.getElementById('back-to-location-btn');

        const mainContentArea = document.getElementById('main-content-area');
        const backToMenuBtn = document.getElementById('back-to-menu-btn'); // Ahora vuelve al perfil

        const cityInput = document.getElementById('city-input');
        const locationNameDisplay = document.getElementById('location-name');
        const coordsDisplay = document.getElementById('coords-display');

        const loadingMessage = document.getElementById('loading-message');
        const errorMessage = document.getElementById('error-message');
        const errorDetail = document.getElementById('error-detail');
        const airQualityData = document.getElementById('airQualityData');
        const icaCard = document.getElementById('ica-card');
        const icaValue = document.getElementById('ica-value');
        const icaLevel = document.getElementById('ica-level');
        const icaDescription = document.getElementById('ica-description');
        const contaminantList = document.getElementById('contaminant-list');
        const healthRecommendationsContainer = document.getElementById('health-recommendations');

        // Textos para errores y estados
        const TEXTS = {
            loading: "Cargando datos del ICA...",
            errorTitle: "&iexcl;Algo sali&oacute; mal!",
            errorGeneric: "No pudimos obtener la calidad del aire. Por favor, verifica tu clave API o la conexi&oacute;n.",
            noData: "No se encontraron datos de calidad del aire para esta ubicaci&oacute;n.",
            cityNotFound: "Ciudad no encontrada. Intenta con otro nombre, el c&oacute;digo de pa&iacute;s o revisa la ortograf&iacute;a.",
            geoDenied: "Acceso a ubicaci&oacute;n denegado. Busca tu ciudad o usa un m&oacute;vil para precisi&oacute;n.",
            geoUnavailable: "Ubicaci&oacute;n no disponible. Por favor, ingresa tu ciudad manualmente.",
            geoSearching: "Buscando tu ubicaci&oacute;n actual..."
        };
        
        // --- UTILIDADES DE INTERFAZ Y FLUJO ---

        /**
         * Muestra el menú de Ubicación (Paso 1).
         */
        function showLocationMenu() {
            mainContentArea.classList.add('hidden');
            healthProfileMenu.classList.add('hidden');
            locationPromptMenu.classList.remove('hidden');
            locationErrorStatus.classList.add('hidden');
        }

        /**
         * Muestra el menú de Perfil de Salud (Paso 2).
         */
        function showHealthProfileMenu() {
            locationPromptMenu.classList.add('hidden');
            mainContentArea.classList.add('hidden');
            healthProfileMenu.classList.remove('hidden');
        }
        
        /**
         * Muestra el &aacute;rea principal de Resultados (Paso 3).
         */
        function showMainContent() {
            locationPromptMenu.classList.add('hidden');
            healthProfileMenu.classList.add('hidden');
            mainContentArea.classList.remove('hidden');
        }

        /**
         * Oculta la pantalla de inicio (Splash Screen) y muestra el menú de Ubicación.
         */
        function hideSplashScreen() {
            splashScreen.classList.add('opacity-0');
            setTimeout(() => {
                splashScreen.classList.add('hidden');
                splashScreen.style.zIndex = -1; 
                mainAppContainer.classList.remove('hidden');
                locationPromptMenu.classList.remove('hidden');
            }, 700);
        }

        /**
         * Muestra el estado de error.
         */
        function displayError(message) {
            loadingMessage.classList.add('hidden');
            airQualityData.classList.add('hidden');
            errorMessage.classList.remove('hidden');
            document.querySelector('#error-message p:first-child').innerHTML = TEXTS.errorTitle;
            document.querySelector('#error-message p:nth-child(3)').innerHTML = TEXTS.errorGeneric;
            errorDetail.textContent = `Detalle: ${message}`;
        }
        
        /**
         * Mapea el valor del ICA (escala OpenWeather 1-5) a una categoría y gradiente de color.
         */
        function getIcaDetails(icaValueOpenWeather) {
            switch (icaValueOpenWeather) {
                case 1:
                    return { level: "Excelente", gradient: "from-green-400 to-teal-500", description: "La calidad del aire es satisfactoria y representa poco riesgo. (ICA 0-50)" };
                case 2:
                    return { level: "Aceptable", gradient: "from-yellow-400 to-lime-500", description: "La calidad del aire es aceptable, pero puede afectar a personas sensibles. (ICA 51-100)" };
                case 3:
                    return { level: "Moderado", gradient: "from-orange-400 to-orange-600", description: "Grupos sensibles deben reducir el esfuerzo prolongado al aire libre. (ICA 101-150)" };
                case 4:
                    return { level: "Pobre", gradient: "from-red-500 to-red-700", description: "Todos pueden comenzar a experimentar efectos. Evitar ejercicio al aire libre. (ICA 151-200)" };
                case 5:
                    return { level: "Peligroso", gradient: "from-red-800 to-red-900", description: "Alerta de emergencia. Toda la poblaci&oacute;n puede verse seriamente afectada. (ICA 201+)" };
                default:
                    return { level: "Desconocido", gradient: "from-gray-400 to-gray-600", description: "Datos de calidad del aire no disponibles." };
            }
        }
        
        function getParticleIcon() {
            return `<svg class="particle-icon text-indigo-500 mr-2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="6"/></svg>`;
        }
        
        function renderContaminants(components) {
            contaminantList.innerHTML = '';
            const labels = {
                co: "Mon&oacute;xido de Carbono (CO)", no: "Mon&oacute;xido de Nitr&oacute;geno (NO)", no2: "Di&oacute;xido de Nitr&oacute;geno (NO<SUB>2</SUB>)",
                o3: "Ozono (O<SUB>3</SUB>)", so2: "Di&oacute;xido de Azufre (SO<SUB>2</SUB>)", pm2_5: "Part&iacute;culas Finas (PM<SUB>2.5</SUB>)",
                pm10: "Part&iacute;culas Gruesas (PM<SUB>10</SUB>)", nh3: "Amoniaco (NH<SUB>3</SUB>)",
            };

            for (const key in components) {
                const label = labels[key] || key.toUpperCase();
                const value = components[key];
                const itemHtml = `
                    <div class="flex items-center justify-between bg-white hover:bg-indigo-50 p-4 rounded-xl border border-gray-100 shadow-sm transition duration-200">
                        <div class="flex items-center">
                            ${getParticleIcon()}
                            <span class="text-base text-gray-700 font-medium">${label}</span>
                        </div>
                        <span class="text-lg font-extrabold text-indigo-700">${value.toFixed(2)} <span class="text-sm font-normal text-gray-500">&micro;g/m&sup3;</span></span>
                    </div>
                `;
                contaminantList.insertAdjacentHTML('beforeend', itemHtml);
            }
        }

        /**
         * Renderiza las recomendaciones de salud basadas en el ICA y el perfil del usuario.
         * @param {number} icaValue - Valor del ICA de 1 a 5.
         * @param {object} profile - Perfil de salud del usuario.
         */
        function renderHealthRecommendations(icaValue, profile) {
            let icon, text, bgColor;
            let generalAdvice = "";
            let sensitiveAdvice = "";

            const isSensitive = profile.asthma || profile.allergies || profile.cardiac || profile.ageSensitive;

            // --- LÓGICA DE RECOMENDACIONES GENERALES ---
            
            switch (icaValue) {
                case 1: // Excelente
                    icon = `<svg xmlns="http://www.w3.org/2000/svg" class="recommendation-icon text-teal-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
                    generalAdvice = "Disfruta de las **actividades al aire libre** sin restricciones.";
                    bgColor = "bg-teal-50 border-teal-200";
                    break;
                case 2: // Aceptable
                    icon = `<svg xmlns="http://www.w3.org/2000/svg" class="recommendation-icon text-lime-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>`;
                    generalAdvice = "La calidad del aire es aceptable. No se requieren medidas especiales para la población general.";
                    bgColor = "bg-lime-50 border-lime-200";
                    break;
                case 3: // Moderado
                    icon = `<svg xmlns="http://www.w3.org/2000/svg" class="recommendation-icon text-orange-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>`;
                    generalAdvice = "Se recomienda **reducir el esfuerzo físico prolongado** al aire libre.";
                    bgColor = "bg-orange-50 border-orange-200";
                    break;
                case 4: // Pobre
                    icon = `<svg xmlns="http://www.w3.org/2000/svg" class="recommendation-icon text-red-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" /></svg>`;
                    generalAdvice = "**Evita todo ejercicio al aire libre**. Todos pueden empezar a sentir efectos en la salud.";
                    bgColor = "bg-red-50 border-red-200";
                    break;
                case 5: // Peligroso
                    icon = `<svg xmlns="http://www.w3.org/2000/svg" class="recommendation-icon text-red-900 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
                    generalAdvice = "**Alerta de Emergencia.** Permanece en interiores, evita salir y limita la ventilaci&oacute;n. M&aacute;ximo riesgo para todos.";
                    bgColor = "bg-red-100 border-red-400";
                    break;
                default:
                    return;
            }

            // --- LÓGICA DE RECOMENDACIONES SENSIBLES (SI APLICA) ---
            if (isSensitive) {
                let sensitiveList = [];
                if (profile.asthma) sensitiveList.push("Asma/Respiratorio");
                if (profile.cardiac) sensitiveList.push("Card&iacute;aco");
                if (profile.allergies) sensitiveList.push("Alergias");
                if (profile.ageSensitive) sensitiveList.push("Edad (Ni&ntilde;os/Mayores)");

                const listNames = sensitiveList.join(', ');
                
                if (icaValue >= 2) {
                    sensitiveAdvice += `<p class="mt-2 text-sm text-red-700 font-semibold border-t pt-2 border-gray-200">
                                            ?? **ATENCI&Oacute;N (${listNames}):**
                                        </p>`;
                }
                
                if (icaValue === 2) {
                    sensitiveAdvice += `<p class="text-xs mt-1">
                        Considera usar mascarilla FFP2 al aire libre si las concentraciones de PM2.5 son altas. **Limita el tiempo de exposici&oacute;n.**
                    </p>`;
                } else if (icaValue === 3) {
                    sensitiveAdvice += `<p class="text-xs mt-1">
                        **Evita cualquier actividad al aire libre.** Mant&eacute;n tus medicamentos de rescate (inhaladores, etc.) a la mano.
                    </p>`;
                } else if (icaValue >= 4) {
                    sensitiveAdvice += `<p class="text-xs mt-1">
                        **NO SALGAS DE CASA.** Sigue el plan de acci&oacute;n m&eacute;dico y consulta a un especialista inmediatamente si aparecen s&iacute;ntomas. Usa purificadores de aire si los tienes.
                    </p>`;
                }
            }


            const recommendationHtml = `
                <div class="flex items-start p-4 rounded-xl border-2 ${bgColor} text-gray-800 shadow-md">
                    <div>
                        <div class="flex items-center mb-1">
                             ${icon}
                             <p class="text-sm font-medium leading-relaxed">${generalAdvice.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')}</p>
                        </div>
                        ${sensitiveAdvice}
                    </div>
                </div>
            `;

            healthRecommendationsContainer.innerHTML = recommendationHtml;
        }

        // --- MANEJO DE APIS Y GEOLOCALIZACIÓN ---

        /**
         * Llama a la API de Calidad del Aire y actualiza la interfaz.
         */
        async function fetchAirQuality() {
            showMainContent();
            loadingMessage.classList.remove('hidden');
            errorMessage.classList.add('hidden');
            airQualityData.classList.add('hidden');
            
            locationNameDisplay.innerHTML = `Monitoreando: ${currentCity}`;
            coordsDisplay.innerHTML = `Coordenadas: Latitud ${currentLat.toFixed(2)}, Longitud ${currentLon.toFixed(2)}`;
            cityInput.value = currentCity.replace(/&aacute;/g, 'á').replace(/&eacute;/g, 'é').replace(/&iacute;/g, 'í').replace(/&oacute;/g, 'ó').replace(/&uacute;/g, 'ú');

            const url = `${AIR_POLLUTION_API_URL}?lat=${currentLat}&lon=${currentLon}&appid=${API_KEY}`;

            try {
                const response = await fetch(url);
                const data = await response.json();

                if (!response.ok || data.cod === 401 || data.cod === '401') {
                    throw new Error(data.message || `Error ${response.status}: Respuesta del servidor no exitosa.`);
                }

                if (data.list && data.list.length > 0) {
                    const currentData = data.list[0];
                    const ica = currentData.main.aqi; 
                    const components = currentData.components;

                    const icaDetails = getIcaDetails(ica);

                    // 1. Actualizar Tarjeta ICA
                    icaCard.className = `rounded-2xl p-8 text-white text-center shadow-2xl bg-gradient-to-br transform transition duration-500 hover:scale-[1.05] cursor-pointer ${icaDetails.gradient}`;
                    icaValue.textContent = ica; 
                    icaLevel.textContent = icaDetails.level;
                    icaDescription.innerHTML = icaDetails.description;
                    
                    // 2. Renderizar Recomendaciones de Salud Personalizadas
                    renderHealthRecommendations(ica, userProfile);

                    // 3. Renderizar Contaminantes
                    renderContaminants(components);

                    airQualityData.classList.remove('hidden');
                    loadingMessage.classList.add('hidden');

                } else {
                    throw new Error(TEXTS.noData);
                }

            } catch (error) {
                displayError(error.message);
            }
        }
        
        /**
         * Convierte el nombre de una ciudad en coordenadas (Geocodificación).
         */
        async function geocodeCity(cityQuery) {
            // No cambiamos la vista, solo buscamos las coordenadas
            const normalizedQuery = cityQuery.replace(/&aacute;/g, 'á').replace(/&eacute;/g, 'é').replace(/&iacute;/g, 'í').replace(/&oacute;/g, 'ó').replace(/&uacute;/g, 'ú');

            if (!cityQuery.trim()) {
                locationErrorStatus.classList.remove('hidden');
                locationErrorStatus.innerHTML = "<strong>Error:</strong> El campo de ciudad no puede estar vacío.";
                return false;
            }
            
            const geoUrl = `${GEO_API_URL}?q=${encodeURIComponent(normalizedQuery)}&limit=1&appid=${API_KEY}`;
            
            try {
                const response = await fetch(geoUrl);
                const data = await response.json();
                
                if (data.length > 0) {
                    const location = data[0];
                    currentLat = location.lat;
                    currentLon = location.lon;
                    
                    let displayName = location.name;
                    if (location.country) {
                        displayName += `, ${location.country}`;
                    }
                    
                    currentCity = displayName.replace('á', '&aacute;').replace('é', '&eacute;').replace('í', '&iacute;').replace('ó', '&oacute;').replace('ú', '&uacute;');
                    
                    cityInput.value = displayName; // Para el campo de texto
                    
                    return true;
                } else {
                    throw new Error(TEXTS.cityNotFound);
                }

            } catch (error) {
                locationErrorStatus.classList.remove('hidden', 'bg-indigo-100', 'border-indigo-300');
                locationErrorStatus.classList.add('bg-red-100', 'border-red-300', 'text-red-600');
                locationErrorStatus.innerHTML = `<strong>Error:</strong> ${error.message}`;
                return false;
            }
        }
        
        /**
         * Convierte coordenadas a nombre de ciudad (Geocodificación Inversa).
         */
        async function reverseGeocodeCoordinates(lat, lon) {
            
            const reverseGeoUrl = `${REVERSE_GEO_API_URL}?lat=${lat}&lon=${lon}&limit=1&appid=${API_KEY}`;
            
            try {
                const response = await fetch(reverseGeoUrl);
                const data = await response.json();
                
                if (data.length > 0) {
                    const location = data[0];
                    let displayName = location.name;
                    if (location.country) {
                        displayName += `, ${location.country}`;
                    }
                    
                    currentCity = displayName.replace('á', '&aacute;').replace('é', '&eacute;').replace('í', '&iacute;').replace('ó', '&oacute;').replace('ú', '&uacute;');
                    cityInput.value = currentCity; 
                } else {
                    currentCity = `Ubicaci&oacute;n Actual (Lat: ${lat.toFixed(2)}, Lon: ${lon.toFixed(2)})`;
                    cityInput.value = "";
                }
                
                showHealthProfileMenu();
            } catch (error) {
                // Si falla la geocodificación inversa, aun podemos continuar
                currentCity = `Ubicaci&oacute;n Actual (Lat: ${lat.toFixed(2)}, Lon: ${lon.toFixed(2)})`;
                showHealthProfileMenu();
            }
        }

        /**
         * Manejador de éxito de Geolocalización.
         */
        function handleGeolocationSuccess(position) {
            currentLat = position.coords.latitude;
            currentLon = position.coords.longitude;
            locationPromptMenu.classList.add('hidden');
            locationPromptMenu.classList.remove('opacity-0');
            reverseGeocodeCoordinates(currentLat, currentLon);
        }

        /**
         * Manejador de error de Geolocalización.
         */
        function handleGeolocationError(error) {
            locationPromptMenu.classList.remove('hidden', 'opacity-0'); 
            locationErrorStatus.classList.remove('hidden', 'text-indigo-600', 'bg-indigo-100', 'border-indigo-300');
            locationErrorStatus.classList.add('text-red-600', 'bg-red-100', 'border-red-300');

            let message = '';
            if (error.code === error.PERMISSION_DENIED) {
                message = TEXTS.geoDenied;
            } else {
                message = TEXTS.geoUnavailable;
            }
            
            locationErrorStatus.innerHTML = `<strong>Error de Ubicaci&oacute;n:</strong> ${message}`;
        }

        /**
         * Inicia el flujo de solicitud de Geolocalización.
         */
        function startGeolocationFlow() {
            locationErrorStatus.classList.remove('hidden', 'text-red-600', 'bg-red-100', 'border-red-300');
            locationErrorStatus.classList.add('text-indigo-600', 'bg-indigo-100', 'border-indigo-300');
            locationErrorStatus.innerHTML = TEXTS.geoSearching;
            
            if (navigator.geolocation) {
                locationPromptMenu.classList.add('opacity-0'); 

                navigator.geolocation.getCurrentPosition(
                    handleGeolocationSuccess,
                    handleGeolocationError,
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            } else {
                handleGeolocationError({code: 0, message: "Geolocalizaci&oacute;n no soportada por el navegador."});
            }
        }
        
        /**
         * Captura el perfil de salud y pasa a la pantalla de resultados.
         */
        function confirmProfile() {
            userProfile.asthma = document.getElementById('profile-asthma').checked;
            userProfile.allergies = document.getElementById('profile-allergies').checked;
            userProfile.cardiac = document.getElementById('profile-cardiac').checked;
            userProfile.ageSensitive = document.getElementById('profile-age').checked;

            fetchAirQuality();
        }

        // --- MANEJADORES DE EVENTOS ---

        // 1. Splash Screen Click
        splashScreen.addEventListener('click', hideSplashScreen);

        // 2. Menu Button: Ubicación Actual (Paso 1)
        locationCurrentBtn.addEventListener('click', startGeolocationFlow);

        // 3. Menu Button: Buscar Destino (Paso 1)
        locationManualBtn.addEventListener('click', async () => {
             // Ocultar el menú de ubicación y mostrar temporalmente el área de búsqueda
             locationPromptMenu.classList.add('hidden');
             mainContentArea.classList.remove('hidden');
             
             // Creamos un modal temporal para ingresar la ciudad manualmente
             const cityModal = document.createElement('div');
             cityModal.className = 'fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center p-4';
             cityModal.innerHTML = `
                 <div class="bg-white rounded-xl p-6 shadow-2xl w-full max-w-sm">
                     <h3 class="text-xl font-bold mb-3">Buscar Destino</h3>
                     <input type="text" id="temp-city-input" placeholder="Ej: 'Buenos Aires, AR'" 
                            class="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:border-indigo-500">
                     <div class="flex justify-end space-x-3">
                         <button id="cancel-search-btn" class="p-2 text-gray-500 hover:text-gray-700">Cancelar</button>
                         <button id="search-city-btn" class="p-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Buscar</button>
                     </div>
                 </div>
             `;
             document.body.appendChild(cityModal);
             document.getElementById('temp-city-input').value = cityInput.value;
             
             const tempCityInput = document.getElementById('temp-city-input');
             tempCityInput.focus();

             const closeAndGoBack = () => {
                 cityModal.remove();
                 // Si se cancela o falla, volvemos al menú de ubicación
                 mainContentArea.classList.add('hidden');
                 showLocationMenu();
             };

             document.getElementById('cancel-search-btn').addEventListener('click', closeAndGoBack);
             
             const performSearch = async () => {
                 const city = tempCityInput.value.trim();
                 if (city) {
                     const success = await geocodeCity(city);
                     if (success) {
                        cityModal.remove();
                        // Una vez que la ubicación se encontró, vamos al perfil de salud
                        showHealthProfileMenu(); 
                     }
                 }
             };

             document.getElementById('search-city-btn').addEventListener('click', performSearch);
             tempCityInput.addEventListener('keypress', (e) => {
                 if (e.key === 'Enter') performSearch();
             });
        });
        
        // 4. Botón Volver al menú de Ubicación (Desde Perfil de Salud)
        backToLocationBtn.addEventListener('click', showLocationMenu);

        // 5. Botón Confirmar Perfil (Desde Perfil de Salud, Paso 2)
        confirmProfileBtn.addEventListener('click', confirmProfile);
        
        // 6. Botón para volver al menú principal (Desde Resultados, Paso 3)
        // Ahora vuelve al menú de perfil para un ajuste rápido.
        backToMenuBtn.addEventListener('click', () => {
            showHealthProfileMenu();
        });


    </script>
</body>
</html>
